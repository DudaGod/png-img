#!/bin/bash

set -e

ROOT_DIR=$(cd $(dirname $0); pwd)
TMP_DIR=/tmp/png-img-build
OS=$(uname -s | tr '[:upper:]' '[:lower:]')

# Build library from sources
# Note: substring '%arch%' in cflags parameters will be replaced with 32 or 64 during configuration step
buildLib() {
    local url=$1
    local install_dir=$2
    local archs=$3
    local cflags=$4
    local extra_settings=$5

    local back=$(pwd)
    cd ${TMP_DIR}

    wget ${url}
    local tar_name=${url##*/}
    tar -xvf $tar_name
    local dir_name=${tar_name%%.[^0-9]*}
    cd ${dir_name}

    for arch in $archs
    do
        mkdir -p ${install_dir}/${arch}
        CFLAGS=$(echo "$cflags" | sed "s;%arch%;$arch;g") \
            ./configure --prefix="${install_dir}/${arch}" ${extra_settings}
        make clean && make && make install
    done

    cd ${back}
}

rm -rf ${TMP_DIR}
mkdir ${TMP_DIR}

if [ "${OS}" = "darwin" ]
then
    ARCHS="64"
else
    # Install some required stuff
    sudo apt-get install \
        gcc-multilib \
        g++-multilib \
        nodejs-legacy

    ARCHS="64 32"
    EXTRA_CFLAGS="-m%arch% -fPIC"

    # Build zlib
    buildLib \
        http://zlib.net/zlib-1.2.8.tar.gz \
        ${ROOT_DIR}/libz \
        "${ARCHS}" \
        "${EXTRA_CFLAGS}"

    EXTRA_CFLAGS="${EXTRA_CFLAGS} -I${ROOT_DIR}/libz/%arch%/include"
fi

# Build libpng
buildLib \
    http://download.sourceforge.net/libpng/libpng-1.6.13.tar.gz \
    ${ROOT_DIR}/libpng \
    "${ARCHS}" \
    "${EXTRA_CFLAGS}" \
    "--enable-static=yes --enable-shared=no"

rm -rf ${TMP_DIR}
