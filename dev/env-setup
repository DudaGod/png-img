#!/bin/bash

set -e

LIBPNG_VERSION=1.6.13
LIBPNG_DIR=$(cd $(dirname $0); pwd)/libpng
TMP_DIR=/tmp/png-img-build
OS=$(uname -s | tr '[:upper:]' '[:lower:]')

rm -rf ${LIBPNG_DIR} ${TMP_DIR}
mkdir ${LIBPNG_DIR}
mkdir ${TMP_DIR}

back=`pwd`
cd ${TMP_DIR}

wget http://download.sourceforge.net/libpng/libpng-${LIBPNG_VERSION}.tar.gz
tar -xvf libpng-${LIBPNG_VERSION}.tar.gz
cd libpng-${LIBPNG_VERSION}

settings="--enable-static=yes --enable-shared=no"

if [ "${OS}" = "darwin" ]
then
    mkdir ${LIBPNG_DIR}/x64
    ./configure --prefix=${LIBPNG_DIR}/x64 ${settings}
    make clean && make && make install
else # linux
    sudo apt-get install \
        gcc-multilib \
        g++-multilib \
        lib32z1-dev \
        nodejs-legacy

    zconf_h=/usr/include/zconf.h
    [ -e ${zconf_h} ] || sudo ln -s /usr/include/x86_64-linux-gnu/zconf.h ${zconf_h}

    for subdir in "ia32" "x64"
    do
        mkdir ${LIBPNG_DIR}/${subdir}
        arch=${subdir//[a-z]/}
        CFLAGS="-m${arch} -fPIC" ./configure --prefix="${LIBPNG_DIR}/${subdir}" ${settings}
        make clean && make && make install
    done
fi

cd $back
rm -rf ${TMP_DIR}
